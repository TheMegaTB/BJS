<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>client/components/config/athleteList/dataInterface.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger"/>
<label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2>
    <h3>Classes</h3>
    <ul>
        <li><a href="Account.html">Account</a></li>
        <li><a href="Athlete.html">Athlete</a>
            <ul class='methods'>
                <li data-type='method'><a href="Athlete.html#.decryptFromDatabase">decryptFromDatabase</a></li>
                <li data-type='method'><a href="Athlete.html#addMeasurement">addMeasurement</a></li>
                <li data-type='method'><a href="Athlete.html#addMeasurements">addMeasurements</a></li>
                <li data-type='method'><a href="Athlete.html#check">check</a></li>
                <li data-type='method'><a href="Athlete.html#encryptForDatabase">encryptForDatabase</a></li>
                <li data-type='method'><a href="Athlete.html#getFullName">getFullName</a></li>
                <li data-type='method'><a href="Athlete.html#getPlain">getPlain</a></li>
                <li data-type='method'><a href="Athlete.html#getShortName">getShortName</a></li>
            </ul>
        </li>
        <li><a href="Data.html">Data</a>
            <ul class='methods'>
                <li data-type='method'><a href="Data.html#findEncrypted">findEncrypted</a></li>
                <li data-type='method'><a href="Data.html#getPlain">getPlain</a></li>
                <li data-type='method'><a href="Data.html#push">push</a></li>
            </ul>
        </li>
        <li><a href="Log.html">Log</a>
            <ul class='methods'>
                <li data-type='method'><a href="Log.html#.getLogObject">getLogObject</a></li>
                <li data-type='method'><a href="Log.html#clear">clear</a></li>
                <li data-type='method'><a href="Log.html#custom">custom</a></li>
                <li data-type='method'><a href="Log.html#disable">disable</a></li>
                <li data-type='method'><a href="Log.html#enable">enable</a></li>
                <li data-type='method'><a href="Log.html#error">error</a></li>
                <li data-type='method'><a href="Log.html#getAsString">getAsString</a></li>
                <li data-type='method'><a href="Log.html#getAsStringWithLevel">getAsStringWithLevel</a></li>
                <li data-type='method'><a href="Log.html#getAsStringWithMinLevel">getAsStringWithMinLevel</a></li>
                <li data-type='method'><a href="Log.html#getHighestLevel">getHighestLevel</a></li>
                <li data-type='method'><a href="Log.html#getHighestLevelMessage">getHighestLevelMessage</a></li>
                <li data-type='method'><a href="Log.html#getLastMessage">getLastMessage</a></li>
                <li data-type='method'><a href="Log.html#info">info</a></li>
                <li data-type='method'><a href="Log.html#merge">merge</a></li>
                <li data-type='method'><a href="Log.html#warning">warning</a></li>
            </ul>
        </li>
        <li><a href="SessionAccount.html">SessionAccount</a>
            <ul class='methods'>
                <li data-type='method'><a href="SessionAccount.html#canViewResults">canViewResults</a></li>
                <li data-type='method'><a href="SessionAccount.html#get">get</a></li>
                <li data-type='method'><a href="SessionAccount.html#isAdminAccount">isAdminAccount</a></li>
                <li data-type='method'><a href="SessionAccount.html#isGroupAccount">isGroupAccount</a></li>
                <li data-type='method'><a href="SessionAccount.html#isLoggedIn">isLoggedIn</a></li>
                <li data-type='method'><a href="SessionAccount.html#isStationAccount">isStationAccount</a></li>
                <li data-type='method'><a href="SessionAccount.html#login">login</a></li>
                <li data-type='method'><a href="SessionAccount.html#logout">logout</a></li>
                <li data-type='method'><a href="SessionAccount.html#setProcessing">setProcessing</a></li>
                <li data-type='method'><a href="SessionAccount.html#store">store</a></li>
            </ul>
        </li>
    </ul>
    <h3>Namespaces</h3>
    <ul>
        <li><a href="AccountManager.html">AccountManager</a>
            <ul class='methods'>
                <li data-type='method'><a href="AccountManager.html#.getAdminAccount">getAdminAccount</a></li>
                <li data-type='method'><a href="AccountManager.html#.getGroupAccount">getGroupAccount</a></li>
                <li data-type='method'><a href="AccountManager.html#.getOutputAccount">getOutputAccount</a></li>
                <li data-type='method'><a href="AccountManager.html#.getStationAccount">getStationAccount</a></li>
                <li data-type='method'><a href="AccountManager.html#.inputPermitted">inputPermitted</a></li>
                <li data-type='method'><a href="AccountManager.html#.login">login</a></li>
                <li data-type='method'><a href="AccountManager.html#.logout">logout</a></li>
                <li data-type='method'><a href="AccountManager.html#.retrieveAccounts">retrieveAccounts</a></li>
                <li data-type='method'><a href="AccountManager.html#.viewPermitted">viewPermitted</a></li>
            </ul>
        </li>
        <li><a href="Athletics.html">Athletics</a>
            <ul class='methods'>
                <li data-type='method'><a href="Athletics.html#.calculate">calculate</a></li>
                <li data-type='method'><a href="Athletics.html#.calculateOne">calculateOne</a></li>
                <li data-type='method'><a href="Athletics.html#.canDoSportType">canDoSportType</a></li>
                <li data-type='method'><a href="Athletics.html#.generateCertificate">generateCertificate</a></li>
                <li data-type='method'><a href="Athletics.html#.getCertificateInfo">getCertificateInfo</a></li>
                <li data-type='method'><a href="Athletics.html#.getInformation">getInformation</a></li>
                <li data-type='method'><a href="Athletics.html#.getNameOfSportType">getNameOfSportType</a></li>
                <li data-type='method'><a href="Athletics.html#.getSports">getSports</a></li>
                <li data-type='method'><a href="Athletics.html#.getSportType">getSportType</a></li>
                <li data-type='method'><a href="Athletics.html#.getValidData">getValidData</a></li>
                <li data-type='method'><a href="Athletics.html#.validate">validate</a></li>
            </ul>
        </li>
        <li><a href="Crypto.html">Crypto</a>
            <ul class='methods'>
                <li data-type='method'><a href="Crypto.html#.encrypt">encrypt</a></li>
                <li data-type='method'><a href="Crypto.html#.generateAC">generateAC</a></li>
                <li data-type='method'><a href="Crypto.html#.generateLoginToken">generateLoginToken</a></li>
                <li data-type='method'><a href="Crypto.html#.generatePrivHash">generatePrivHash</a></li>
                <li data-type='method'><a href="Crypto.html#.generatePubHash">generatePubHash</a></li>
                <li data-type='method'><a href="Crypto.html#.tryDecrypt">tryDecrypt</a></li>
            </ul>
        </li>
        <li><a href="Gymnastics.html">Gymnastics</a>
            <ul class='methods'>
                <li data-type='method'><a href="Gymnastics.html#.calculate">calculate</a></li>
                <li data-type='method'><a href="Gymnastics.html#.canDoSportType">canDoSportType</a></li>
                <li data-type='method'><a href="Gymnastics.html#.generateCertificate">generateCertificate</a></li>
                <li data-type='method'><a href="Gymnastics.html#.getCertificateInfo">getCertificateInfo</a></li>
                <li data-type='method'><a href="Gymnastics.html#.getInformation">getInformation</a></li>
                <li data-type='method'><a href="Gymnastics.html#.getNameOfSportType">getNameOfSportType</a></li>
                <li data-type='method'><a href="Gymnastics.html#.getSports">getSports</a></li>
                <li data-type='method'><a href="Gymnastics.html#.getSportType">getSportType</a></li>
                <li data-type='method'><a href="Gymnastics.html#.getValidData">getValidData</a></li>
                <li data-type='method'><a href="Gymnastics.html#.validate">validate</a></li>
            </ul>
        </li>
        <li><a href="Server.html">Server</a>
            <ul class='methods'>
                <li data-type='method'><a href="Server.html#.getIPs">getIPs</a></li>
                <li data-type='method'><a href="Server.html#.getLog">getLog</a></li>
                <li data-type='method'><a href="Server.html#.setSportTypeState">setSportTypeState</a></li>
            </ul>
        </li>
        <li><a href="Swimming.html">Swimming</a>
            <ul class='methods'>
                <li data-type='method'><a href="Swimming.html#.calculate">calculate</a></li>
                <li data-type='method'><a href="Swimming.html#.canDoSportType">canDoSportType</a></li>
                <li data-type='method'><a href="Swimming.html#.generateCertificate">generateCertificate</a></li>
                <li data-type='method'><a href="Swimming.html#.getCertificateInfo">getCertificateInfo</a></li>
                <li data-type='method'><a href="Swimming.html#.getInformation">getInformation</a></li>
                <li data-type='method'><a href="Swimming.html#.getNameOfSportType">getNameOfSportType</a></li>
                <li data-type='method'><a href="Swimming.html#.getSports">getSports</a></li>
                <li data-type='method'><a href="Swimming.html#.getSportType">getSportType</a></li>
                <li data-type='method'><a href="Swimming.html#.getValidData">getValidData</a></li>
                <li data-type='method'><a href="Swimming.html#.validate">validate</a></li>
            </ul>
        </li>
    </ul>
    <h3>Global</h3>
    <ul>
        <li><a href="global.html#canViewResults">canViewResults</a></li>
        <li><a href="global.html#checkAdminLogin">checkAdminLogin</a></li>
        <li><a href="global.html#checkLogin">checkLogin</a></li>
        <li><a href="global.html#filterUndefined">filterUndefined</a></li>
        <li><a href="global.html#genRandomAdminCode">genRandomAdminCode</a></li>
        <li><a href="global.html#genRandomCode">genRandomCode</a></li>
        <li><a href="global.html#genUUID">genUUID</a></li>
        <li><a href="global.html#getAccountByPassphrase">getAccountByPassphrase</a></li>
        <li><a href="global.html#getAcsFromAccounts">getAcsFromAccounts</a></li>
        <li><a href="global.html#getAdminAccount">getAdminAccount</a></li>
        <li><a href="global.html#getContestTypeByID">getContestTypeByID</a></li>
        <li><a href="global.html#getGroupNames">getGroupNames</a></li>
        <li><a href="global.html#getLoginObject">getLoginObject</a></li>
        <li><a href="global.html#getLoginToken">getLoginToken</a></li>
        <li><a href="global.html#getStationNames">getStationNames</a></li>
        <li><a href="global.html#getStationNamesAsArray">getStationNamesAsArray</a></li>
        <li><a href="global.html#initCollections">initCollections</a></li>
        <li><a href="global.html#isAdminAccount">isAdminAccount</a></li>
        <li><a href="global.html#isGroupAccount">isGroupAccount</a></li>
        <li><a href="global.html#isStationAccount">isStationAccount</a></li>
        <li><a href="global.html#refreshErrorState">refreshErrorState</a></li>
        <li><a href="global.html#runAsyncServerFunction">runAsyncServerFunction</a></li>
        <li><a href="global.html#runServerFunction">runServerFunction</a></li>
    </ul>
</nav>

<div id="main">

    <h1 class="page-title">client/components/config/athleteList/dataInterface.js</h1>


    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {currentCompID, forwardIcon, editMode} from "../config";
import {Server} from "../../../../imports/api/database/ServerInterface";
import {showIndicator, hideIndicator} from "../../helpers";
import {AccountManager} from "../../../../imports/api/accountManagement/AccountManager";
import {Athlete} from "../../../../imports/api/logic/athlete";
import {genUUID} from "../../../../imports/api/crypto/pwdgen";
import {Log} from "../../../../imports/api/log";
import * as gender from "gender-guess";

export const localGroups = new ReactiveVar([]);
export const athleteErrorState = new ReactiveVar({});
export const selectedAthlete = new ReactiveVar(undefined);

const defaultBirthYear = new Date().getFullYear() - 17;

let asyncUUID = undefined;


// Load athletes from storage
Tracker.autorun(async function () {
    const compID = currentCompID.get();
    const inEditMode = Tracker.nonreactive(function () {
        return editMode.get()
    });
    if (compID) {
        if (inEditMode) Meteor.f7.showPreloader("Daten laden");
        else showIndicator();
        //noinspection JSCheckFunctionSignatures
        localGroups.set([]);

        if (asyncUUID) Server.cancelAsyncRequest(asyncUUID);

        asyncUUID = await Server.athletes.getAsync(AccountManager.getAdminAccount().account, compID, false, false, function (athlete, last, entry) {
            if (entry.index == 0 &amp;&amp; !inEditMode)
                hideIndicator();
            if (athlete === false) {
                Meteor.f7.alert("Es ist ein Fehler beim Laden der Athleten aufgetreten!", "Fehler");
                return;
            }
            athlete = Athlete.fromObject(Meteor.config.log, athlete);
            addRawAthlete(athlete, true);

            if (inEditMode) {
                document.getElementsByClassName('modal-title')[0].innerHTML = entry.index + "/" + entry.size;
            }

            if (last)
                refreshErrorState();
        }, function (entry) {
            if (entry.size == 0) hideIndicator();
            if (inEditMode) Meteor.f7.hidePreloader();
        });
    }
});

/**
 *
 * @param {string} [id]
 * @param {string} [firstName]
 * @param {string} [lastName]
 */
export function refreshErrorState(id, firstName, lastName) {
    // Calculate the group state
    let lgroups = localGroups.get();
    let errorLevel = 0;

    const errorStates = {};

    for (let group in lgroups) {
        if (!lgroups.hasOwnProperty(group)) continue;
        group = lgroups[group];

        let groupErrLevel = 0;
        for (let athlete in group.athletes) {
            if (!group.athletes.hasOwnProperty(athlete)) continue;
            const athleteLog = new Log();

            let athlete = group.athletes[athlete];
            if (id &amp;&amp; athlete.id === id) {
                athlete.firstName = firstName;
                athlete.lastName = lastName;
                if (athlete.isMale === undefined) {
                    const genderGuess = gender.guess(firstName);
                    if (genderGuess !== undefined &amp;&amp; typeof genderGuess.gender === 'string' &amp;&amp; genderGuess.confidence > 0.96) athlete.isMale = genderGuess.gender == "M";
                }
            }

            athlete.check(athleteLog);
            const athleteMessage = athleteLog.getHighestLevelMessage();
            errorStates[athlete.id] = athleteMessage;
            if (athleteMessage.level > groupErrLevel) groupErrLevel = athleteMessage.level;
        }

        errorStates[group.id] = {level: groupErrLevel};
        if (groupErrLevel > errorLevel) errorLevel = groupErrLevel;
    }

    if (errorLevel > 0)
        forwardIcon.set({
            level: errorLevel,
            template: errorLevel == 1 ? "iconWarn" : "iconErr",
            data: {text: errorLevel == 1 ? "Einer der Athleten hat womöglich ungültige Daten" : "Einer der Athleten beinhaltet einen Fehler"}
        });
    else
        forwardIcon.set(undefined);

    //noinspection JSCheckFunctionSignatures
    athleteErrorState.set(errorStates);
}

// ------------------- ATHLETE RELATED FUNCTIONS -------------------

export function writeAthlete(athlete) {
    if (!editMode.get()) return;
    const admin = AccountManager.getAdminAccount();
    Server.athletes.write(admin.account, currentCompID.get(), athlete.encryptForDatabase(admin.account, admin.account), athlete.id);
    refreshErrorState();
}

export function addAthlete(gid) {
    const compID = currentCompID.get();
    const lgroups = localGroups.get();
    let groupID;
    for (let group in lgroups) {
        if (!lgroups.hasOwnProperty(group)) continue;
        if (lgroups[group].id === gid) {
            groupID = group;
            break;
        }
    }

    const ct = Server.contest.getType(compID);

    addRawAthlete(new Athlete(Meteor.config.log, "", "", defaultBirthYear, undefined, lgroups[groupID].name, '0', ct.maxAge, ct, genUUID()));
}

export function addRawAthlete(athlete, skipWrite) {
    let gid;
    if (!groupExists(athlete.group)) gid = addGroup(athlete.group);
    else gid = getGroupIDByName(athlete.group);
    modifyGroup(gid, function (group) {
        group.athletes.push(athlete);
    });
    if (!skipWrite) writeAthlete(athlete);
    refreshErrorState();
}

export function modifyAthlete(id, callback) {
    if (!editMode.get()) return;
    const lgroups = localGroups.get();
    for (let group in lgroups) {
        if (!lgroups.hasOwnProperty(group)) continue;
        let athletes = lgroups[group].athletes;
        for (let athlete in athletes) {
            if (!athletes.hasOwnProperty(athlete)) continue;
            let a = athletes[athlete];
            if (a.id == id) {
                callback(a, group, athlete);
                writeAthlete(a);
                localGroups.set(lgroups);
                return;
            }
        }
    }
}

export function removeAthlete(id) {
    const lgroups = localGroups.get();
    let groupIndex, athleteIndex;
    outerLoop:
        for (let group in lgroups) {
            if (!lgroups.hasOwnProperty(group)) continue;
            let athletes = lgroups[group].athletes;
            for (let athlete in athletes) {
                if (!athletes.hasOwnProperty(athlete)) continue;
                let a = athletes[athlete];
                if (a.id == id) {
                    groupIndex = group;
                    athleteIndex = athlete;
                    break outerLoop;
                }
            }
        }
    Server.athletes.remove(AccountManager.getAdminAccount().account, currentCompID.get(), lgroups[groupIndex].athletes[athleteIndex].id);
    lgroups[groupIndex].athletes.splice(athleteIndex, 1);
    localGroups.set(lgroups);
    refreshErrorState();
}

// -------------------- GROUP RELATED FUNCTIONS --------------------

export function addGroup(name) {
    if (groupExists(name)) {
        Meteor.f7.alert("Eine Gruppe mit diesem Namen existiert bereits!", "Fehler");
    } else {
        const lgroups = localGroups.get();
        const id = genUUID();
        lgroups.push({name: name, athletes: [], collapsed: false, id: id});
        localGroups.set(lgroups);
        refreshErrorState();
        return id;
    }
}

export function modifyGroup(id, callback) {
    const lgroups = localGroups.get();
    for (let group in lgroups) {
        if (!lgroups.hasOwnProperty(group)) continue;
        if (lgroups[group].id === id) {
            callback(lgroups[group], group);
            localGroups.set(lgroups);
            return group;
        }
    }
}

export function removeGroup(id) {
    const contestID = currentCompID.get();

    // Tell the server we deleted all athletes
    const groupIndex = modifyGroup(id, function (group) {
        for (let athlete in group.athletes) {
            if (!group.athletes.hasOwnProperty(athlete)) continue;
            Server.athletes.remove(AccountManager.getAdminAccount().account, contestID, group.athletes[athlete].id);
        }
    });

    // Delete the group locally
    const lgroups = localGroups.get();
    lgroups.splice(groupIndex, 1);
    localGroups.set(lgroups);

    // Update the error states
    refreshErrorState();
}

export function renameGroup(id, newName) {
    if (groupExists(newName)) {
        Meteor.f7.alert("Eine Gruppe mit diesem Namen existiert bereits!", "Fehler");
    } else {
        modifyGroup(id, function (group) {
            group.name = newName;
            for (let athlete in group.athletes) {
                if (!group.athletes.hasOwnProperty(athlete)) continue;
                athlete = group.athletes[athlete];
                athlete.group = newName;
                writeAthlete(athlete);
            }
        });
    }
}

export function getGroupIDByName(name) {
    const lgroups = localGroups.get();
    for (let group in lgroups) {
        if (!lgroups.hasOwnProperty(group)) continue;
        if (lgroups[group].name === name)
            return lgroups[group].id;
    }
    return undefined;
}

export function groupExists(name) {
    const lgroups = localGroups.get();
    for (let group in lgroups) {
        if (!lgroups.hasOwnProperty(group)) continue;
        if (lgroups[group].name == name) return true;
    }
    return false;
}</code></pre>
        </article>
    </section>


</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Fri Jan 20 2017 16:01:16
    GMT+0100 (CET) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
