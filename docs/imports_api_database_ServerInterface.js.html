<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>imports/api/database/ServerInterface.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger"/>
<label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2>
    <h3>Classes</h3>
    <ul>
        <li><a href="Account.html">Account</a></li>
        <li><a href="Athlete.html">Athlete</a>
            <ul class='methods'>
                <li data-type='method'><a href="Athlete.html#.decryptFromDatabase">decryptFromDatabase</a></li>
                <li data-type='method'><a href="Athlete.html#addMeasurement">addMeasurement</a></li>
                <li data-type='method'><a href="Athlete.html#addMeasurements">addMeasurements</a></li>
                <li data-type='method'><a href="Athlete.html#check">check</a></li>
                <li data-type='method'><a href="Athlete.html#encryptForDatabase">encryptForDatabase</a></li>
                <li data-type='method'><a href="Athlete.html#getFullName">getFullName</a></li>
                <li data-type='method'><a href="Athlete.html#getPlain">getPlain</a></li>
                <li data-type='method'><a href="Athlete.html#getShortName">getShortName</a></li>
            </ul>
        </li>
        <li><a href="Data.html">Data</a>
            <ul class='methods'>
                <li data-type='method'><a href="Data.html#findEncrypted">findEncrypted</a></li>
                <li data-type='method'><a href="Data.html#getPlain">getPlain</a></li>
                <li data-type='method'><a href="Data.html#push">push</a></li>
            </ul>
        </li>
        <li><a href="Log.html">Log</a>
            <ul class='methods'>
                <li data-type='method'><a href="Log.html#.getLogObject">getLogObject</a></li>
                <li data-type='method'><a href="Log.html#clear">clear</a></li>
                <li data-type='method'><a href="Log.html#custom">custom</a></li>
                <li data-type='method'><a href="Log.html#disable">disable</a></li>
                <li data-type='method'><a href="Log.html#enable">enable</a></li>
                <li data-type='method'><a href="Log.html#error">error</a></li>
                <li data-type='method'><a href="Log.html#getAsString">getAsString</a></li>
                <li data-type='method'><a href="Log.html#getAsStringWithLevel">getAsStringWithLevel</a></li>
                <li data-type='method'><a href="Log.html#getAsStringWithMinLevel">getAsStringWithMinLevel</a></li>
                <li data-type='method'><a href="Log.html#getHighestLevel">getHighestLevel</a></li>
                <li data-type='method'><a href="Log.html#getHighestLevelMessage">getHighestLevelMessage</a></li>
                <li data-type='method'><a href="Log.html#getLastMessage">getLastMessage</a></li>
                <li data-type='method'><a href="Log.html#info">info</a></li>
                <li data-type='method'><a href="Log.html#merge">merge</a></li>
                <li data-type='method'><a href="Log.html#warning">warning</a></li>
            </ul>
        </li>
        <li><a href="SessionAccount.html">SessionAccount</a>
            <ul class='methods'>
                <li data-type='method'><a href="SessionAccount.html#canViewResults">canViewResults</a></li>
                <li data-type='method'><a href="SessionAccount.html#get">get</a></li>
                <li data-type='method'><a href="SessionAccount.html#isAdminAccount">isAdminAccount</a></li>
                <li data-type='method'><a href="SessionAccount.html#isGroupAccount">isGroupAccount</a></li>
                <li data-type='method'><a href="SessionAccount.html#isLoggedIn">isLoggedIn</a></li>
                <li data-type='method'><a href="SessionAccount.html#isStationAccount">isStationAccount</a></li>
                <li data-type='method'><a href="SessionAccount.html#login">login</a></li>
                <li data-type='method'><a href="SessionAccount.html#logout">logout</a></li>
                <li data-type='method'><a href="SessionAccount.html#setProcessing">setProcessing</a></li>
                <li data-type='method'><a href="SessionAccount.html#store">store</a></li>
            </ul>
        </li>
    </ul>
    <h3>Namespaces</h3>
    <ul>
        <li><a href="AccountManager.html">AccountManager</a>
            <ul class='methods'>
                <li data-type='method'><a href="AccountManager.html#.getAdminAccount">getAdminAccount</a></li>
                <li data-type='method'><a href="AccountManager.html#.getGroupAccount">getGroupAccount</a></li>
                <li data-type='method'><a href="AccountManager.html#.getOutputAccount">getOutputAccount</a></li>
                <li data-type='method'><a href="AccountManager.html#.getStationAccount">getStationAccount</a></li>
                <li data-type='method'><a href="AccountManager.html#.inputPermitted">inputPermitted</a></li>
                <li data-type='method'><a href="AccountManager.html#.login">login</a></li>
                <li data-type='method'><a href="AccountManager.html#.logout">logout</a></li>
                <li data-type='method'><a href="AccountManager.html#.retrieveAccounts">retrieveAccounts</a></li>
                <li data-type='method'><a href="AccountManager.html#.viewPermitted">viewPermitted</a></li>
            </ul>
        </li>
        <li><a href="Athletics.html">Athletics</a>
            <ul class='methods'>
                <li data-type='method'><a href="Athletics.html#.calculate">calculate</a></li>
                <li data-type='method'><a href="Athletics.html#.calculateOne">calculateOne</a></li>
                <li data-type='method'><a href="Athletics.html#.canDoSportType">canDoSportType</a></li>
                <li data-type='method'><a href="Athletics.html#.generateCertificate">generateCertificate</a></li>
                <li data-type='method'><a href="Athletics.html#.getCertificateInfo">getCertificateInfo</a></li>
                <li data-type='method'><a href="Athletics.html#.getInformation">getInformation</a></li>
                <li data-type='method'><a href="Athletics.html#.getNameOfSportType">getNameOfSportType</a></li>
                <li data-type='method'><a href="Athletics.html#.getSports">getSports</a></li>
                <li data-type='method'><a href="Athletics.html#.getSportType">getSportType</a></li>
                <li data-type='method'><a href="Athletics.html#.getValidData">getValidData</a></li>
                <li data-type='method'><a href="Athletics.html#.validate">validate</a></li>
            </ul>
        </li>
        <li><a href="Crypto.html">Crypto</a>
            <ul class='methods'>
                <li data-type='method'><a href="Crypto.html#.encrypt">encrypt</a></li>
                <li data-type='method'><a href="Crypto.html#.generateAC">generateAC</a></li>
                <li data-type='method'><a href="Crypto.html#.generateLoginToken">generateLoginToken</a></li>
                <li data-type='method'><a href="Crypto.html#.generatePrivHash">generatePrivHash</a></li>
                <li data-type='method'><a href="Crypto.html#.generatePubHash">generatePubHash</a></li>
                <li data-type='method'><a href="Crypto.html#.tryDecrypt">tryDecrypt</a></li>
            </ul>
        </li>
        <li><a href="Gymnastics.html">Gymnastics</a>
            <ul class='methods'>
                <li data-type='method'><a href="Gymnastics.html#.calculate">calculate</a></li>
                <li data-type='method'><a href="Gymnastics.html#.canDoSportType">canDoSportType</a></li>
                <li data-type='method'><a href="Gymnastics.html#.generateCertificate">generateCertificate</a></li>
                <li data-type='method'><a href="Gymnastics.html#.getCertificateInfo">getCertificateInfo</a></li>
                <li data-type='method'><a href="Gymnastics.html#.getInformation">getInformation</a></li>
                <li data-type='method'><a href="Gymnastics.html#.getNameOfSportType">getNameOfSportType</a></li>
                <li data-type='method'><a href="Gymnastics.html#.getSports">getSports</a></li>
                <li data-type='method'><a href="Gymnastics.html#.getSportType">getSportType</a></li>
                <li data-type='method'><a href="Gymnastics.html#.getValidData">getValidData</a></li>
                <li data-type='method'><a href="Gymnastics.html#.validate">validate</a></li>
            </ul>
        </li>
        <li><a href="Server.html">Server</a>
            <ul class='methods'>
                <li data-type='method'><a href="Server.html#.getIPs">getIPs</a></li>
                <li data-type='method'><a href="Server.html#.getLog">getLog</a></li>
                <li data-type='method'><a href="Server.html#.setSportTypeState">setSportTypeState</a></li>
            </ul>
        </li>
        <li><a href="Swimming.html">Swimming</a>
            <ul class='methods'>
                <li data-type='method'><a href="Swimming.html#.calculate">calculate</a></li>
                <li data-type='method'><a href="Swimming.html#.canDoSportType">canDoSportType</a></li>
                <li data-type='method'><a href="Swimming.html#.generateCertificate">generateCertificate</a></li>
                <li data-type='method'><a href="Swimming.html#.getCertificateInfo">getCertificateInfo</a></li>
                <li data-type='method'><a href="Swimming.html#.getInformation">getInformation</a></li>
                <li data-type='method'><a href="Swimming.html#.getNameOfSportType">getNameOfSportType</a></li>
                <li data-type='method'><a href="Swimming.html#.getSports">getSports</a></li>
                <li data-type='method'><a href="Swimming.html#.getSportType">getSportType</a></li>
                <li data-type='method'><a href="Swimming.html#.getValidData">getValidData</a></li>
                <li data-type='method'><a href="Swimming.html#.validate">validate</a></li>
            </ul>
        </li>
    </ul>
    <h3>Global</h3>
    <ul>
        <li><a href="global.html#canViewResults">canViewResults</a></li>
        <li><a href="global.html#checkAdminLogin">checkAdminLogin</a></li>
        <li><a href="global.html#checkLogin">checkLogin</a></li>
        <li><a href="global.html#filterUndefined">filterUndefined</a></li>
        <li><a href="global.html#genRandomCode">genRandomCode</a></li>
        <li><a href="global.html#genUUID">genUUID</a></li>
        <li><a href="global.html#getAccountByPassphrase">getAccountByPassphrase</a></li>
        <li><a href="global.html#getAcsFromAccounts">getAcsFromAccounts</a></li>
        <li><a href="global.html#getAdminAccount">getAdminAccount</a></li>
        <li><a href="global.html#getContestTypeByID">getContestTypeByID</a></li>
        <li><a href="global.html#getGroupNames">getGroupNames</a></li>
        <li><a href="global.html#getLoginObject">getLoginObject</a></li>
        <li><a href="global.html#getLoginToken">getLoginToken</a></li>
        <li><a href="global.html#getStationNames">getStationNames</a></li>
        <li><a href="global.html#getStationNamesAsArray">getStationNamesAsArray</a></li>
        <li><a href="global.html#initCollections">initCollections</a></li>
        <li><a href="global.html#isAdminAccount">isAdminAccount</a></li>
        <li><a href="global.html#isGroupAccount">isGroupAccount</a></li>
        <li><a href="global.html#isStationAccount">isStationAccount</a></li>
        <li><a href="global.html#refreshErrorState">refreshErrorState</a></li>
        <li><a href="global.html#runAsyncServerFunction">runAsyncServerFunction</a></li>
        <li><a href="global.html#runServerFunction">runServerFunction</a></li>
    </ul>
</nav>

<div id="main">

    <h1 class="page-title">imports/api/database/ServerInterface.js</h1>


    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {getContestTypeByID} from "../logic/contestType";
import {Athlete} from "../logic/athlete";
import {initCollections} from "./collections/index";
import {getLoginObject} from "../logic/account";
import {Log} from "../log";
import {Crypto} from "../crypto/crypto";
import {asyncServerFunctionChannel} from "../streamer";

if (Meteor.isClient) {
    initCollections();
}

function throwError(account, returnPromise) {
    const err = new Error("Error whilst calling a server function.");
    console.error("-------- Error Context --------");
    console.error("Function called:", name);
    console.error("Account used:", account);
    console.error("Data to be transmitted:", data);
    console.error("Callback passed:", callback);
    console.error("Return type:", returnPromise ? "Promise" : "Callback");
    Meteor.f7.alert("Es gab einen Fehler beim Verbinden mit dem Server. Bitte melden Sie sich ab und versuchen Sie es erneut.", "Fehler");
    throw err;
}

/**
 * Runs a function server-side and takes care of de-/encryption for you. It calls the callback once with the results returned from the server.
 * @param {string} name - The name of the server function
 * @param {Account} account - The account that is used to authenticate
 * @param {*} data - A data object which will be passed to the function. These data will be send encrypted.
 * @param {function} [callback] - A callback with one parameter: The return value of the server function. Function returns a promise if it is undefined.
 */
function runServerFunction(name, account, data, callback) {
    const loginObject = getLoginObject(account);
    const log = Log.getLogObject();
    const returnPromise = typeof callback !== 'function';
    const callFunction = returnPromise ? Meteor.callPromise : Meteor.call;

    const promise = callFunction('runServerFunction', name, loginObject, Crypto.encrypt(data, account.ac, account.ac), function (err, enc_data) {
        const data = Crypto.tryDecrypt(log, enc_data, [account.ac]);
        if (data) {
            if (typeof callback === 'function') callback(data.data);
        } else if (Meteor.isClient) {
            throwError(account, returnPromise);
        }
    });

    if (returnPromise)
        return promise.then(data => {
            const decrypted_data = Crypto.tryDecrypt(log, data, [account.ac]);

            if (!decrypted_data &amp;&amp; Meteor.isClient)
                throwError(account, returnPromise);
            else
                return decrypted_data.data;
        });
}

const interruptedChannels = {};
/**
 * Runs a function server-side in an asynchronous manner and takes care of de-/encryption for you. It calls the callback for every entry returned.
 * @param {string} name - The name of the server function
 * @param {Account} account - The account that is used to authenticate
 * @param {*} data - A data object which will be passed to the function. These data will be send encrypted.
 * @param {function} callback - A callback with one parameter: The return value of the server function. Function returns a promise if it is undefined.
 * @param {function} [doneCallback] - A callback that gets called when the last entry has been processed or in case there were none. Called with the raw data object
 * @returns {Promise.&lt;void>}
 */
async function runAsyncServerFunction(name, account, data, callback, doneCallback) {
    const log = Log.getLogObject();
    const connection = await runServerFunction('runAsync', account, {name: name, data: data});

    // TODO: This handler will get set more than one time! This NEEDS to be fixed -somehow- +locally check if it was interrupted
    asyncServerFunctionChannel.on(connection.uuid, function (encryptedEntry) {
        if (interruptedChannels[connection.uuid] === true) {
            delete interruptedChannels[connection.uuid];
            asyncServerFunctionChannel.stop(connection.uuid);
            if (typeof doneCallback === 'function') {
                doneCallback({});
            }
        } else {
            const entry = Crypto.tryDecrypt(log, encryptedEntry, [account.ac]);

            if (entry &amp;&amp; !entry.data.permissionDenied) {
                if (entry.data.done &amp;&amp; typeof doneCallback === 'function') doneCallback(entry.data);
                else if (typeof callback === 'function') callback(entry.data.data, entry.data.index == entry.data.size, entry.data);
            } else if (Meteor.isClient) {
                if (entry.data.permissionDenied) console.warn("Server denied permission on async callback");
                throwError(account, false);
            }
        }
    });

    asyncServerFunctionChannel.emit('clientReady', connection.uuid);

    return connection.uuid;
}

/**
 * Object containing all information and functions for communication w/ the server.
 * @public
 * @namespace
 */
export let Server = {

    cancelAsyncRequest: function (id) {
        // Interrupt server
        asyncServerFunctionChannel.emit('interrupt', id);
        // Interrupt client
        interruptedChannels[id] = true;
    },

    db: {
        /**
         * Returns the id of the server settings document.
         * @returns {string} The id
         */
        getGenericID: function () {
            return Meteor.COLLECTIONS.Generic.handle.find().fetch()[0]._id;
        },

        /**
         * Returns whether all collections are ready.
         * @return {boolean}
         */
        isReady: function () {
            return Meteor.COLLECTIONS.Generic.isReady() &amp;&amp;
                Meteor.COLLECTIONS.Contests.isReady() &amp;&amp;
                Meteor.COLLECTIONS.Accounts.isReady() &amp;&amp;
                Meteor.COLLECTIONS.Athletes.isReady();
        },

        /**
         * This function waits asynchronously until all collections are ready. Then it calls the callback.
         * @param {function} callback - The callback
         */
        waitForReady: function (callback) {
            // TODO Replace w/ waterfall
            Meteor.COLLECTIONS.Generic.onReady(function () { //TODO automate for all collections
                Meteor.COLLECTIONS.Contests.onReady(function () {
                    Meteor.COLLECTIONS.Accounts.onReady(function () {
                        Meteor.COLLECTIONS.Athletes.onReady(function () {
                            callback();
                        });
                    });
                });
            });
        },
    },

    customAccounts: {
        store: function (account, contestID, customAccounts) {
            runServerFunction('storeCustomAccounts', account, {
                contestID: contestID,
                customAccounts: customAccounts
            });
        },
        retrieve: function (account, contestID) {
            return runServerFunction('retrieveCustomAccounts', account, {contestID: contestID});
        },
    },

    certificates: {
        /**
         * Updates a certificate of an athlete.
         * @param {Account} account - Output account
         * @param {boolean} id - The meteor db id of the athlete
         * @param [callback] - optional callback
         */
        update: function (account, id, callback) {
            runServerFunction('certificateUpdate', account, {id: id}, callback);
        },

        /**
         * Generates certificates for the current contest
         * @param {Account} account - Output account
         * @param {object[]} athleteIDs - List of athlete ids
         * @param [callback] - optional callback
         */
        generate: function (account, athleteIDs, callback) {
            runServerFunction('generateCertificates', account, {athleteIDs: athleteIDs}, callback);
        },
    },

    athletes: {
        count: function (account, contestID) {
            return runServerFunction('getAthleteCount', account, {contestID: contestID});
        },
        getAsync: function (account, contestID, require_signature, require_group_check, callback, doneCallback) {
            return runAsyncServerFunction('getAthletes', account, {
                contestID: contestID,
                require_signature: require_signature,
                require_group_check: require_group_check
            }, callback, doneCallback);
        },

        /**
         *
         * @param {Log} log - A log object
         * @param {Account[]} accounts - The account
         * @param {boolean} require_signature - Only decrypt data if the signature can be verified. Should be true for final certificate creation.
         * @returns {Athlete[]}
         */
        getByAccounts: function (log, accounts, require_signature) {
            let result = [];
            log.disable();
            //iterate athletes
            Meteor.COLLECTIONS.Athletes.handle.find().fetch().forEach(function (obj) {
                //try to decrypt with accounts
                const decrypted = Athlete.decryptFromDatabase(log, obj, accounts, require_signature);

                //if decrypted add to result
                if (decrypted) {
                    result.push(decrypted);
                }
            });
            log.enable();
            return result;
        },
    },

    contest: {
        /**
         * Returns the active contest object
         * @param [contestID] - ID of the contest to return
         * @returns {object}
         */
        get: function (contestID) {
            if (!contestID) contestID = Server.contest.getActiveID();
            return Meteor.COLLECTIONS.Contests.handle.findOne({_id: contestID});
        },
        add: function (account, name, contestType) {
            runServerFunction('addContest', account, {name: name, contestType: contestType});
        },
        lock: function (account, contestID, callback) {
            runServerFunction('lockContest', account, {contestID: contestID}, callback);
        },
        /**
         * Renames a contest with a given name
         * @param {Account} account - Admin account
         * @param {string} contestID - The id of the contest
         * @param {string} newName - The new name
         * @param [callback] - optional callback
         */
        rename: function (account, contestID, newName, callback) {
            runServerFunction('renameContest', account, {contestID: contestID, newName: newName}, callback);
        },
        /**
         * Removes a contest with a given name. The actual data are still in the db. Only the link is deleted.
         * @param {Account} account - Admin account
         * @param {string} contestID - The name of the contest
         * @param [callback] - optional callback
         */
        remove: function (account, contestID, callback) {
            runServerFunction('removeContest', account, {contestID: contestID}, callback);
        },
        /**
         * Activates a contest with a given name
         * @param {Account} account - Admin account
         * @param {string} contestID - The id of the contest
         * @param [callback] - optional callback
         */
        activate: function (account, contestID, callback) {
            runServerFunction('activateContest', account, {contestID: contestID}, callback);
        },
        /**
         * Returns the current or a given contest type
         * @param {Mongo.Collection} [contestID] - Handle of the db
         * @returns {object}
         */
        getType: function (contestID) {
            if (!contestID) contestID = Server.contest.getActiveID();
            return getContestTypeByID(Server.contest.get(contestID).type);
        },
        /**
         * Returns the active contest database ID
         * @returns {string}
         */
        getActiveID: function () {
            return Meteor.COLLECTIONS.Generic.handle.findOne({_id: Server.db.getGenericID()}).activeContest;
        },
    },

    /**
     * Set the state of a sportType for a given contest ID
     * @param account
     * @param contestID
     * @param sportTypeID
     * @param state
     * @param callback
     */
    setSportTypeState: function (account, contestID, sportTypeID, state, callback) {
        runServerFunction('setSportTypeState', account, {
            contestID: contestID,
            sportTypeID: sportTypeID,
            state: state
        }, callback);
    },

    // TODO: Replace this with a delta function
    writeAthletes: function (account, contestID, encryptedAthletes, callback) {
        runServerFunction('writeAthletes', account, {
            contestID: contestID,
            encryptedAthletes: encryptedAthletes
        }, callback);
    },

    // TODO: Replace this with a delta function
    writeAccounts: function (account, contestID, accounts, callback) {
        runServerFunction('writeAccounts', account, {contestID: contestID, accounts: accounts}, callback);
    },

    /**
     * Returns all ips of the server
     * @param {Account} account - Admin account
     * @param [callback] - optional callback
     */
    getIPs: function (account, callback) {
        runServerFunction('getServerIPs', account, {}, callback);
    },

    /**
     * Generates certificates for the current contest
     * @param {Account} account - Admin account
     * @param [callback] - optional callback
     */
    getLog: function (account, callback) {
        runServerFunction('getLog', account, {}, callback);
    }
};</code></pre>
        </article>
    </section>


</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Tue Jan 17 2017 16:15:37
    GMT+0100 (CET) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
